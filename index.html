<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å­¸ç¿’ç·´ç¿’ App (ç¶²é ç‰ˆ)</title>
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
    
    <style>
        /* --- å…¨åŸŸæ¨£å¼ --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f5f5f5;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
            padding-bottom: constant(safe-area-inset-bottom); /* iOS é©é… */
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* å°è¦½åˆ— */
        .header {
            background-color: #fff;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .header-title { font-size: 18px; font-weight: bold; color: #333; }
        .icon-btn { font-size: 24px; color: #333; cursor: pointer; display: flex; align-items: center; }
        
        .badge {
            position: absolute; right: -5px; top: -5px; background-color: red; color: white;
            border-radius: 50%; width: 18px; height: 18px; font-size: 10px; font-weight: bold;
            display: flex; justify-content: center; align-items: center; border: 2px solid #fff;
        }

        /* é é¢åˆ‡æ›æ§åˆ¶ */
        .page { display: none; padding: 20px; max-width: 800px; margin: 0 auto; height: calc(100vh - 60px); box-sizing: border-box; }
        .page.active { display: block; }
        /* Unit Screen éœ€è¦ç‰¹æ®Šä½ˆå±€ (æ»¿ç‰ˆ) */
        #unit-screen.page.active { display: flex; flex-direction: column; padding: 0; }

        /* --- é¦–é æ¨£å¼ --- */
        .card { height: 150px; border-radius: 20px; display: flex; flex-direction: column; justify-content: center; alignItems: center; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); cursor: pointer; color: white; text-align: center; }
        .math-card { background-color: #4A90E2; }
        .science-card { background-color: #50E3C2; }
        .card h1 { margin: 0; font-size: 32px; }
        .card p { margin: 5px 0 0; font-size: 16px; opacity: 0.9; }

        /* --- å–®å…ƒåˆ—è¡¨æ¨£å¼ --- */
        .unit-card { background: #fff; padding: 15px; border-radius: 12px; margin-bottom: 15px; display: flex; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1); cursor: pointer; }
        .unit-icon { width: 50px; height: 50px; border-radius: 25px; display: flex; justify-content: center; align-items: center; font-size: 24px; margin-right: 15px; color: #fff; }

        /* --- å–®å…ƒè©³ç´°é æ¨£å¼ (Tabs & Content) --- */
        .tab-container { display: flex; border-bottom: 1px solid #eee; background: #fff; }
        .tab { flex: 1; padding: 15px 0; text-align: center; cursor: pointer; color: #666; font-size: 16px; }
        .tab.active { border-bottom: 3px solid #007AFF; color: #007AFF; font-weight: bold; }
        
        .content-area { flex: 1; background: #f9f9f9; overflow-y: auto; position: relative; }
        
        /* PDF ä¸‹è¼‰æ¢ */
        .download-bar { padding: 12px; text-align: center; border-bottom: 1px solid #ddd; background: #e3f2fd; color: #1565c0; font-weight: bold; cursor: pointer; }
        .download-bar.answer { background: #e8f5e9; color: #2e7d32; border-color: #c8e6c9; }
        
        /* ç•™è¨€æ¿æ¨£å¼ */
        .chat-container { padding: 15px; padding-bottom: 80px; }
        .comment-item { background: #fff; padding: 12px; margin-bottom: 10px; border-radius: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .comment-user { font-size: 12px; color: #888; margin-bottom: 4px; }
        .comment-text { font-size: 16px; color: #333; word-break: break-all; }
        
        /* ç•™è¨€è¼¸å…¥æ¡† */
        .input-area {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: #fff; border-top: 1px solid #eee; padding: 10px;
            display: flex; gap: 10px; z-index: 50;
            max-width: 800px; margin: 0 auto; /* é™åˆ¶åœ¨å¤§è¢å¹•çš„å¯¬åº¦ */
        }
        .chat-input { flex: 1; background: #f0f0f0; border: none; border-radius: 20px; padding: 10px 15px; font-size: 16px; outline: none; }
        .send-btn { background: #007AFF; color: white; border: none; border-radius: 20px; padding: 0 20px; font-weight: bold; cursor: pointer; }

        /* PDF iframe */
        .pdf-frame { width: 100%; height: 100%; border: none; }
        .center-msg { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%; text-align: center; color: #666; padding: 20px; }

        /* Modal æ¨£å¼ */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: #fff; width: 85%; max-width: 400px; border-radius: 15px; padding: 20px; }
        .btn { width: 100%; padding: 10px; margin-top: 10px; border: none; border-radius: 8px; color: white; font-weight: bold; cursor: pointer; }
        .btn-blue { background: #2196F3; } .btn-red { background: #d9534f; }
        
        /* éš±è—/é¡¯ç¤ºæ§åˆ¶ */
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div class="header">
        <div class="icon-btn" onclick="openSettings()" id="settings-btn">
            <ion-icon name="settings-outline"></ion-icon>
        </div>
        <div class="icon-btn" onclick="handleBack()" id="back-btn" style="display: none;">
            <ion-icon name="arrow-back-outline"></ion-icon>
        </div>
        
        <div class="header-title" id="header-title">é¦–é </div>
        
        <div class="icon-btn" style="position: relative;">
            <ion-icon name="notifications-outline" style="color: #007AFF;"></ion-icon>
            <div id="badge" class="badge" style="display: none;">0</div>
        </div>
    </div>

    <div id="home-screen" class="page active">
        <div style="text-align: center; margin: 30px 0; font-size: 20px; font-weight: bold; color: #333;" id="greeting-text">å—¨! åŒå­¸ é¸æ“‡ç§‘ç›®ä¾†ç·´ç¿’å§</div>
        <div class="card math-card" onclick="goToSubject('math')">
            <h1>ğŸ“ æ•¸å­¸</h1><p>Mathematics</p>
        </div>
        <div class="card science-card" onclick="goToSubject('science')">
            <h1>ğŸ§ª ç†åŒ–</h1><p>Science</p>
        </div>
        <div id="teacher-section" style="display: none; background: #fffbe6; padding: 15px; border-radius: 10px; margin-top: 20px; border: 1px solid #ffe58f;">
            <p style="text-align: center; font-weight: bold; color: #666; margin-top: 0;">--- è€å¸«ç™¼é€é€šçŸ¥å€ ---</p>
            <button class="btn btn-blue" onclick="alert('è«‹åœ¨ App æ“ä½œä¸Šå‚³ï¼Œç¶²é ç‰ˆåƒ…ä¾›ç€è¦½èˆ‡é€šçŸ¥')">â• æ–°å¢å–®å…ƒ / ä¸Šå‚³æª”æ¡ˆ</button>
            <div style="margin: 10px 0; color: #555;">ç™¼é€ç›®æ¨™å–®å…ƒï¼š</div>
            <select id="admin-unit-select" style="width: 100%; padding: 10px; margin-bottom: 10px; border-radius: 5px; border: 1px solid #ddd;">
                <option value="">è¼‰å…¥ä¸­...</option>
            </select>
            <div style="display: flex; gap: 10px;">
                <button class="btn" style="background: #FF9800;" onclick="simulateTeacherUpload('question')">ğŸ“¢ é€šçŸ¥ï¼šæ–°é¡Œç›®</button>
                <button class="btn" style="background: #4CAF50;" onclick="simulateTeacherUpload('answer')">ğŸ“¢ é€šçŸ¥ï¼šæ–°è©³è§£</button>
            </div>
        </div>
    </div>

    <div id="subject-screen" class="page">
        <div id="unit-list-container"></div>
    </div>

    <div id="unit-screen" class="page">
        <div class="tab-container">
            <div class="tab active" onclick="switchTab('question')" id="tab-question">é¡Œç›®å·</div>
            <div class="tab" onclick="switchTab('answer')" id="tab-answer">è©³è§£å·</div>
            <div class="tab" onclick="switchTab('chat')" id="tab-chat">è¨è«–å€</div>
        </div>

        <div class="content-area" id="unit-content">
            <div id="panel-question" style="height: 100%; display: flex; flex-direction: column;">
                <div id="dl-question" class="download-bar" onclick="openPdf(currentUnitData?.questionPdf)">ğŸ“¥ ä¸‹è¼‰/åˆ—å°é¡Œç›®å·</div>
                <div id="viewer-question" style="flex: 1;"></div>
            </div>

            <div id="panel-answer" style="height: 100%; display: none; flex-direction: column;">
                <div id="dl-answer" class="download-bar answer" onclick="openPdf(currentUnitData?.answerPdf)">ğŸ“¥ ä¸‹è¼‰/åˆ—å°è©³è§£å·</div>
                <div id="viewer-answer" style="flex: 1;"></div>
            </div>

            <div id="panel-chat" style="display: none; height: 100%;">
                <div class="chat-container" id="chat-list">
                    <div style="text-align: center; color: #999; margin-top: 20px;">è¼‰å…¥ç•™è¨€ä¸­...</div>
                </div>
                <div class="input-area">
                    <input type="text" id="comment-input" class="chat-input" placeholder="è¼¸å…¥å•é¡Œ..." onkeypress="handleEnter(event)">
                    <button class="send-btn" onclick="sendComment()">é€å‡º</button>
                </div>
            </div>
        </div>
    </div>

    <div id="settings-modal" class="modal-overlay" onclick="if(event.target === this) this.style.display='none'">
        <div class="modal-content">
            <h2 style="text-align: center;">è¨­å®š</h2>
            <div id="auth-ui">
                <input type="email" id="login-email" placeholder="Email" style="width: 100%; padding: 10px; margin-bottom: 10px; box-sizing: border-box;">
                <input type="password" id="login-pwd" placeholder="Password" style="width: 100%; padding: 10px; margin-bottom: 10px; box-sizing: border-box;">
                <button class="btn btn-blue" onclick="login()">ç®¡ç†å“¡ç™»å…¥</button>
            </div>
            <button class="btn" style="background: #ccc; color: #333;" onclick="document.getElementById('settings-modal').style.display='none'">é—œé–‰</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, query, orderBy, limit, onSnapshot, getDocs, getDoc, doc, where, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // â–¼â–¼â–¼ è«‹å¡«å…¥ä½ çš„ Firebase Config â–¼â–¼â–¼
        const firebaseConfig = {
  apiKey: "AIzaSyA4rX2ZjJqto9Eyv4G_xdlAdYAH3uJCMBo",
  authDomain: "reviewtest-f016d.firebaseapp.com",
  projectId: "reviewtest-f016d",
  storageBucket: "reviewtest-f016d.firebasestorage.app",
  messagingSenderId: "170552561842",
  appId: "1:170552561842:web:a204553261698d7311b9ab",
  measurementId: "G-RQ20L5H9S4"
};
        // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const ADMIN_EMAIL = "ulysses950710@gmail.com";

        // å…¨åŸŸè®Šæ•¸
        window.currentUser = null;
        window.currentUnitData = null;
        window.currentUnitId = null;
        let unsubscribeChat = null; // ç”¨ä¾†å–æ¶ˆç›£è½ç•™è¨€

        // --- 1. èº«ä»½é©—è­‰èˆ‡åˆå§‹åŒ– ---
        onAuthStateChanged(auth, (user) => {
            window.currentUser = user;
            if (user && user.email === ADMIN_EMAIL) {
                document.getElementById('teacher-section').style.display = 'block';
                document.getElementById('greeting-text').innerText = `å—¨! ${user.displayName || 'è€å¸«'} (ç®¡ç†å“¡)`;
                
                // ç™»å…¥å¾Œä»‹é¢æ”¹è®Š
                const authUI = document.getElementById('auth-ui');
                authUI.innerHTML = `<p>ç›®å‰ç™»å…¥ï¼š${user.email}</p><button class="btn btn-red" onclick="logout()">ç™»å‡º</button>`;
                
                fetchUnitsForAdmin(); // è¼‰å…¥è€å¸«ç”¨çš„ä¸‹æ‹‰é¸å–®
            } else {
                document.getElementById('teacher-section').style.display = 'none';
                document.getElementById('greeting-text').innerText = "å—¨! åŒå­¸ é¸æ“‡ç§‘ç›®ä¾†ç·´ç¿’å§";
                document.getElementById('auth-ui').innerHTML = `
                    <input type="email" id="login-email" placeholder="Email" style="width:100%;padding:10px;margin-bottom:10px;"><input type="password" id="login-pwd" placeholder="Password" style="width:100%;padding:10px;margin-bottom:10px;"><button class="btn btn-blue" onclick="login()">ç®¡ç†å“¡ç™»å…¥</button>
                `;
            }
            listenNotifications();
        });

        window.login = async () => {
            const email = document.getElementById('login-email').value;
            const pwd = document.getElementById('login-pwd').value;
            try { await signInWithEmailAndPassword(auth, email, pwd); document.getElementById('settings-modal').style.display='none'; }
            catch(e) { alert("ç™»å…¥å¤±æ•—: " + e.message); }
        };
        window.logout = async () => { await signOut(auth); document.getElementById('settings-modal').style.display='none'; };

        // --- 2. è·¯ç”±æ§åˆ¶ ---
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            
            // Header æŒ‰éˆ•æ§åˆ¶
            if(pageId === 'home-screen') {
                document.getElementById('back-btn').style.display = 'none';
                document.getElementById('settings-btn').style.display = 'flex';
                document.getElementById('header-title').innerText = 'é¦–é ';
            } else {
                document.getElementById('back-btn').style.display = 'flex';
                document.getElementById('settings-btn').style.display = 'none';
            }
        }

        window.handleBack = () => {
            if(document.getElementById('unit-screen').classList.contains('active')) {
                // å¾å–®å…ƒé å›åˆ°ç§‘ç›®åˆ—è¡¨
                if(unsubscribeChat) { unsubscribeChat(); unsubscribeChat = null; }
                showPage('subject-screen');
                document.getElementById('header-title').innerText = 'å–®å…ƒåˆ—è¡¨';
            } else {
                // å¾ç§‘ç›®åˆ—è¡¨å›åˆ°é¦–é 
                showPage('home-screen');
            }
        };

        window.openSettings = () => document.getElementById('settings-modal').style.display = 'flex';

        // --- 3. ç§‘ç›®åˆ—è¡¨ ---
        window.goToSubject = async (subjectId) => {
            showPage('subject-screen');
            const container = document.getElementById('unit-list-container');
            container.innerHTML = '<p style="text-align:center;">è¼‰å…¥ä¸­...</p>';
            document.getElementById('header-title').innerText = (subjectId === 'math' ? 'æ•¸å­¸' : 'ç†åŒ–') + 'å–®å…ƒåˆ—è¡¨';

            const themeColor = subjectId === 'math' ? '#4A90E2' : '#50E3C2';
            const q = query(collection(db, 'units'), where('subject', '==', subjectId), orderBy('order', 'asc'));
            
            try {
                const snap = await getDocs(q);
                if(snap.empty) { container.innerHTML = '<p style="text-align:center;">ç„¡å–®å…ƒ</p>'; return; }
                
                let html = '';
                snap.forEach(doc => {
                    const data = doc.data();
                    html += `
                        <div class="unit-card" onclick="goToUnit('${doc.id}')">
                            <div class="unit-icon" style="background-color: ${themeColor};">${subjectId === 'math'?'ğŸ“':'ğŸ§ª'}</div>
                            <div><h3>${data.title}</h3><p>é»æ“ŠæŸ¥çœ‹é¡Œç›®èˆ‡è©³è§£</p></div>
                        </div>`;
                });
                container.innerHTML = html;
            } catch(e) { console.error(e); container.innerHTML = 'è®€å–éŒ¯èª¤'; }
        };

        // --- 4. å–®å…ƒè©³ç´°é  (æ ¸å¿ƒåŠŸèƒ½) ---
        window.goToUnit = async (unitId) => {
            window.currentUnitId = unitId;
            showPage('unit-screen');
            document.getElementById('header-title').innerText = 'è¼‰å…¥ä¸­...';
            
            // é‡ç½® Tab
            switchTab('question');

            try {
                const docSnap = await getDoc(doc(db, 'units', unitId));
                if(docSnap.exists()) {
                    window.currentUnitData = docSnap.data();
                    document.getElementById('header-title').innerText = window.currentUnitData.title;
                    
                    // æ¸²æŸ“ PDF é¡¯ç¤ºå™¨
                    renderPdfViewer('question', window.currentUnitData.questionPdf);
                    renderPdfViewer('answer', window.currentUnitData.answerPdf);
                } else { alert('æ‰¾ä¸åˆ°å–®å…ƒ'); handleBack(); }
            } catch(e) { console.error(e); alert('è®€å–å¤±æ•—'); }
            
            // å•Ÿå‹•ç•™è¨€ç›£è½
            loadComments(unitId);
        };

        // Tab åˆ‡æ›
        window.switchTab = (tabName) => {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.add('active');

            ['question', 'answer', 'chat'].forEach(t => {
                document.getElementById(`panel-${t}`).style.display = (t === tabName) ? (t === 'chat' ? 'block' : 'flex') : 'none';
            });
        };

        // PDF æ¸²æŸ“é‚è¼¯
        function renderPdfViewer(type, url) {
            const viewer = document.getElementById(`viewer-${type}`);
            const dlBtn = document.getElementById(`dl-${type}`);
            
            if(!url) {
                viewer.innerHTML = `<div class="center-msg">å°šæœªä¸Šå‚³æª”æ¡ˆ</div>`;
                dlBtn.style.display = 'none';
                return;
            }
            
            dlBtn.style.display = 'block';
            
            // åˆ¤æ–·æ˜¯å¦ç‚ºæ‰‹æ©Ÿ (å¯¬åº¦å°æ–¼ 768px è¦–ç‚ºæ‰‹æ©Ÿ)
            const isMobile = window.innerWidth < 768;
            
            if (isMobile) {
                // æ‰‹æ©Ÿç‰ˆï¼šé¡¯ç¤ºå¤§åœ–æ¨™å¼•å°é»æ“Šï¼Œä¸å…§åµŒ iframe (iOS iframe é«”é©—å·®)
                viewer.innerHTML = `
                    <div class="center-msg">
                        <p>æ‰‹æ©Ÿç‰ˆå»ºè­°ç›´æ¥é–‹å•Ÿ PDF é–±è®€</p>
                        <button class="btn btn-blue" style="width:auto;" onclick="openPdf('${url}')">ğŸ“„ é»æ­¤é–‹å•Ÿ PDF</button>
                    </div>
                `;
            } else {
                // é›»è…¦ç‰ˆï¼šä½¿ç”¨ iframe
                viewer.innerHTML = `<iframe src="${url}" class="pdf-frame"></iframe>`;
            }
        }
        
        window.openPdf = (url) => { if(url) window.open(url, '_blank'); else alert('ç„¡é€£çµ'); };

        // --- 5. ç•™è¨€æ¿åŠŸèƒ½ ---
        function loadComments(unitId) {
            if(unsubscribeChat) unsubscribeChat(); // å…ˆå–æ¶ˆèˆŠçš„
            
            const q = query(collection(db, 'units', unitId, 'comments'), orderBy('createdAt', 'desc'));
            const listEl = document.getElementById('chat-list');
            
            unsubscribeChat = onSnapshot(q, (snap) => {
                if(snap.empty) {
                    listEl.innerHTML = '<div style="text-align:center;color:#999;margin-top:20px;">é‚„æ²’æœ‰ç•™è¨€ï¼Œä¾†æ¶é ­é¦™å§ï¼</div>';
                    return;
                }
                let html = '';
                // åè½‰é †åºé¡¯ç¤º (æ–°ç•™è¨€åœ¨ä¸‹? æˆ–æ˜¯æ¨¡ä»¿ App å€’åº? App æ˜¯ inverted FlatListï¼Œä»£è¡¨æ–°ç•™è¨€åœ¨åº•éƒ¨)
                // é€™è£¡æˆ‘å€‘ç”¨æ¨™æº–ç¶²é é‚è¼¯ï¼šæ–°ç•™è¨€åœ¨ä¸‹ï¼Œä½†å› ç‚º snapshot æ˜¯ desc (æ–°åˆ°èˆŠ)ï¼Œæ‰€ä»¥æˆ‘å€‘è·‘è¿´åœˆæ™‚è¦åéä¾†æ’å…¥ï¼Œæˆ–è€…ç›´æ¥ç”¨ flex-column-reverse
                // ç°¡å–®ä½œæ³•ï¼šç›´æ¥ç”±ä¸Šå¾€ä¸‹æ¸²æŸ“ snapshot (æ–°ç•™è¨€åœ¨æœ€ä¸Šé¢) -> ç¬¦åˆ desc æ’åº
                snap.forEach(doc => {
                    const data = doc.data();
                    const name = data.userName || data.userEmail.split('@')[0];
                    html += `
                        <div class="comment-item">
                            <div class="comment-user">${name}:</div>
                            <div class="comment-text">${data.text}</div>
                        </div>
                    `;
                });
                listEl.innerHTML = html;
            });
        }

        window.handleEnter = (e) => { if(e.key === 'Enter') sendComment(); };

        window.sendComment = async () => {
            const input = document.getElementById('comment-input');
            const text = input.value.trim();
            if(!text) return;
            if(!window.currentUser) return alert('è«‹å…ˆé»æ“Šå·¦ä¸Šè§’è¨­å®š -> ç™»å…¥');

            const user = window.currentUser;
            const name = user.displayName || user.email.split('@')[0];
            
            try {
                // å¯«å…¥ç•™è¨€
                await addDoc(collection(db, 'units', window.currentUnitId, 'comments'), {
                    text: text,
                    userEmail: user.email,
                    userName: name,
                    createdAt: serverTimestamp()
                });
                
                // å¯«å…¥é€šçŸ¥ (è§¸ç™¼ç´…é»)
                await addDoc(collection(db, 'notifications'), {
                    type: 'comment',
                    title: `ğŸ’¬ ${window.currentUnitData.title} æœ‰æ–°ç•™è¨€`,
                    body: `${name}: ${text}`,
                    unitId: window.currentUnitId,
                    targetTab: 'chat',
                    createdAt: serverTimestamp(),
                    senderEmail: user.email
                });
                
                input.value = '';
                // è‡ªå‹•æ²å‹•åˆ°æœ€ä¸Šæ–¹ (å› ç‚ºæˆ‘å€‘æ˜¯æŠŠæœ€æ–°ç•™è¨€é¡¯ç¤ºåœ¨æœ€ä¸Šé¢)
                document.getElementById('unit-content').scrollTop = 0;
                
            } catch(e) {
                console.error(e);
                alert('ç•™è¨€å¤±æ•—');
            }
        };

        // --- 6. è€å¸«å»£æ’­ (æ•´åˆåœ¨é¦–é ) ---
        async function fetchUnitsForAdmin() {
            const q = query(collection(db, 'units'), orderBy('order', 'asc'));
            const snap = await getDocs(q);
            const select = document.getElementById('admin-unit-select');
            select.innerHTML = '';
            snap.forEach(doc => {
                const opt = document.createElement('option');
                opt.value = doc.id;
                opt.text = doc.data().title;
                // æŠŠæ•´å€‹ data ç¶å®šä¸Šå»æ–¹ä¾¿ä¹‹å¾Œç”¨
                opt.dataset.title = doc.data().title;
                select.appendChild(opt);
            });
        }

        window.simulateTeacherUpload = async (type) => {
            const select = document.getElementById('admin-unit-select');
            const unitId = select.value;
            if(!unitId) return alert('è«‹é¸æ“‡å–®å…ƒ');
            
            const title = select.options[select.selectedIndex].dataset.title;
            const isQ = type === 'question';
            
            try {
                await addDoc(collection(db, 'notifications'), {
                    type: 'file',
                    title: isQ ? 'ğŸ“„ é¡Œç›®å·' : 'âœ… è©³è§£å·',
                    body: `å–®å…ƒã€Œ${title}ã€å·²ç¶“æ›´æ–°${isQ?'é¡Œç›®':'è©³è§£'}å›‰ï¼`,
                    unitId: unitId,
                    senderEmail: window.currentUser.email,
                    targetTab: type,
                    createdAt: serverTimestamp()
                });
                alert('å·²ç™¼é€é€šçŸ¥ï¼');
            } catch(e) { alert(e.message); }
        };

        // --- 7. ç´…é»ç›£è½ ---
        function listenNotifications() {
            const lastRead = parseInt(localStorage.getItem('lastReadTime') || '0');
            const q = query(collection(db, 'notifications'), orderBy('createdAt', 'desc'), limit(50));
            onSnapshot(q, (snap) => {
                const count = snap.docs.filter(doc => {
                    const d = doc.data();
                    const isNew = (d.createdAt?.toMillis() || 0) > lastRead;
                    const notMe = window.currentUser ? d.senderEmail !== window.currentUser.email : true;
                    return isNew && notMe;
                }).length;
                const badge = document.getElementById('badge');
                if(count > 0) { badge.style.display = 'flex'; badge.innerText = count>9?'9+':count; }
                else badge.style.display = 'none';
            });
            
            // é»æ“Šéˆ´éºæ¶ˆç´…é»
            document.getElementById('badge').parentElement.onclick = () => {
                localStorage.setItem('lastReadTime', Date.now().toString());
                document.getElementById('badge').style.display = 'none';
                alert('é€šçŸ¥å·²æ¸…é™¤');
            };
        }
    </script>
</body>
</html>