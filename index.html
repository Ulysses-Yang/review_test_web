<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å­¸ç¿’ç·´ç¿’ App (ç¶²é ç‰ˆ)</title>
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
    
    <style>
        /* --- å…¨åŸŸæ¨£å¼ --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f5f5f5;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
            padding-bottom: constant(safe-area-inset-bottom);
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* å°è¦½åˆ— */
        .header {
            background-color: #fff;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .header-title { font-size: 18px; font-weight: bold; color: #333; }
        .icon-btn { font-size: 24px; color: #333; cursor: pointer; display: flex; align-items: center; }
        
        .badge {
            position: absolute; right: -5px; top: -5px; background-color: red; color: white;
            border-radius: 50%; width: 18px; height: 18px; font-size: 10px; font-weight: bold;
            display: flex; justify-content: center; align-items: center; border: 2px solid #fff;
        }

        /* é é¢åˆ‡æ›æ§åˆ¶ */
        .page { display: none; padding: 20px; max-width: 800px; margin: 0 auto; height: calc(100vh - 60px); box-sizing: border-box; }
        .page.active { display: block; }
        #unit-screen.page.active { display: flex; flex-direction: column; padding: 0; }

        /* --- é¦–é æ¨£å¼ --- */
        .card { height: 150px; border-radius: 20px; display: flex; flex-direction: column; justify-content: center; alignItems: center; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); cursor: pointer; color: white; text-align: center; }
        .math-card { background-color: #4A90E2; }
        .science-card { background-color: #50E3C2; }
        .card h1 { margin: 0; font-size: 32px; }
        .card p { margin: 5px 0 0; font-size: 16px; opacity: 0.9; }

        /* --- å–®å…ƒåˆ—è¡¨æ¨£å¼ --- */
        .unit-card { background: #fff; padding: 15px; border-radius: 12px; margin-bottom: 15px; display: flex; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1); cursor: pointer; }
        .unit-icon { width: 50px; height: 50px; border-radius: 25px; display: flex; justify-content: center; align-items: center; font-size: 24px; margin-right: 15px; color: #fff; }

        /* --- å–®å…ƒè©³ç´°é æ¨£å¼ --- */
        .tab-container { display: flex; border-bottom: 1px solid #eee; background: #fff; }
        .tab { flex: 1; padding: 15px 0; text-align: center; cursor: pointer; color: #666; font-size: 16px; }
        .tab.active { border-bottom: 3px solid #007AFF; color: #007AFF; font-weight: bold; }
        
        .content-area { flex: 1; background: #f9f9f9; overflow-y: auto; position: relative; }
        
        .download-bar { padding: 12px; text-align: center; border-bottom: 1px solid #ddd; background: #e3f2fd; color: #1565c0; font-weight: bold; cursor: pointer; }
        .download-bar.answer { background: #e8f5e9; color: #2e7d32; border-color: #c8e6c9; }
        
        /* ç•™è¨€æ¿æ¨£å¼ */
        .chat-container { padding: 15px; padding-bottom: 140px; /* é ç•™åº•éƒ¨ç™»å…¥æ¡†ç©ºé–“ */ }
        .comment-item { background: #fff; padding: 12px; margin-bottom: 10px; border-radius: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .comment-user { font-size: 12px; color: #888; margin-bottom: 4px; }
        .comment-text { font-size: 16px; color: #333; word-break: break-all; }
        
        /* åº•éƒ¨å€åŸŸ (åŒ…å«è¼¸å…¥æ¡† æˆ– ç™»å…¥æ¡†) */
        .bottom-action-area {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: #fff; border-top: 1px solid #eee; padding: 15px;
            z-index: 50; max-width: 800px; margin: 0 auto;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.05);
        }

        /* ç•™è¨€è¼¸å…¥æ¨¡å¼ */
        .input-row { display: flex; gap: 10px; }
        .chat-input { flex: 1; background: #f0f0f0; border: none; border-radius: 20px; padding: 10px 15px; font-size: 16px; outline: none; }
        .send-btn { background: #007AFF; color: white; border: none; border-radius: 20px; padding: 0 20px; font-weight: bold; cursor: pointer; }

        /* ç™»å…¥æ¨¡å¼ */
        .auth-row { display: flex; flex-direction: column; gap: 10px; }
        .auth-title { text-align: center; font-size: 14px; color: #666; margin-bottom: 5px; }
        .auth-inputs { display: flex; gap: 10px; }
        .auth-inputs input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 8px; }
        .auth-btns { display: flex; gap: 10px; }
        .auth-btns button { flex: 1; padding: 10px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; }
        .btn-login { background: #007AFF; color: white; }
        .btn-register { background: #E0E0E0; color: #333; }

        /* PDF iframe */
        .pdf-frame { width: 100%; height: 100%; border: none; }
        .center-msg { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%; text-align: center; color: #666; padding: 20px; }

        /* Modal (é€šç”¨èˆ‡é€šçŸ¥) */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: #fff; width: 90%; max-width: 400px; max-height: 80vh; border-radius: 15px; padding: 20px; display: flex; flex-direction: column; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .modal-body { overflow-y: auto; flex: 1; }
        
        /* é€šçŸ¥åˆ—è¡¨é …ç›® */
        .notif-item { padding: 12px; border-bottom: 1px solid #f0f0f0; cursor: pointer; }
        .notif-item:active { background: #f9f9f9; }
        .notif-title { font-weight: bold; color: #333; margin-bottom: 5px; }
        .notif-body { font-size: 14px; color: #666; }
        .notif-time { font-size: 12px; color: #999; margin-top: 5px; text-align: right; }
        .new-badge { display: inline-block; background: red; width: 8px; height: 8px; border-radius: 50%; margin-right: 5px; }

        .btn { padding: 10px; margin-top: 10px; border: none; border-radius: 8px; color: white; font-weight: bold; cursor: pointer; text-align: center; }
        .btn-blue { background: #2196F3; } .btn-red { background: #d9534f; }
        .close-btn { background: transparent; border: none; font-size: 24px; color: #999; cursor: pointer; }
    </style>
</head>
<body>

    <div class="header">
        <div class="icon-btn" onclick="openSettings()" id="settings-btn">
            <ion-icon name="person-circle-outline"></ion-icon>
        </div>
        
        <div class="icon-btn" onclick="handleBack()" id="back-btn" style="display: none;">
            <ion-icon name="arrow-back-outline"></ion-icon>
        </div>
        
        <div class="header-title" id="header-title">é¦–é </div>
        
        <div class="icon-btn" style="position: relative;" onclick="openNotifications()">
            <ion-icon name="notifications-outline" style="color: #007AFF;"></ion-icon>
            <div id="badge" class="badge" style="display: none;">0</div>
        </div>
    </div>

    <div id="home-screen" class="page active">
        <div style="text-align: center; margin: 30px 0; font-size: 20px; font-weight: bold; color: #333;" id="greeting-text">å—¨! åŒå­¸ é¸æ“‡ç§‘ç›®ä¾†ç·´ç¿’å§</div>
        <div class="card math-card" onclick="goToSubject('math')">
            <h1>ğŸ“ æ•¸å­¸</h1><p>Mathematics</p>
        </div>
        <div class="card science-card" onclick="goToSubject('science')">
            <h1>ğŸ§ª ç†åŒ–</h1><p>Science</p>
        </div>
        
        <div id="teacher-section" style="display: none; background: #fffbe6; padding: 15px; border-radius: 10px; margin-top: 20px; border: 1px solid #ffe58f;">
            <p style="text-align: center; font-weight: bold; color: #666; margin-top: 0;">--- è€å¸«ç™¼é€é€šçŸ¥å€ ---</p>
            <div style="margin: 10px 0; color: #555;">ç›®æ¨™å–®å…ƒï¼š</div>
            <select id="admin-unit-select" style="width: 100%; padding: 10px; margin-bottom: 10px;">
                <option value="">è¼‰å…¥ä¸­...</option>
            </select>
            <div style="display: flex; gap: 10px;">
                <button class="btn" style="background: #FF9800; flex:1;" onclick="simulateTeacherUpload('question')">ğŸ“¢ é€šçŸ¥é¡Œç›®æ›´æ–°</button>
                <button class="btn" style="background: #4CAF50; flex:1;" onclick="simulateTeacherUpload('answer')">ğŸ“¢ é€šçŸ¥è©³è§£æ›´æ–°</button>
            </div>
        </div>
    </div>

    <div id="subject-screen" class="page">
        <div id="unit-list-container"></div>
    </div>

    <div id="unit-screen" class="page">
        <div class="tab-container">
            <div class="tab active" onclick="switchTab('question')" id="tab-question">é¡Œç›®å·</div>
            <div class="tab" onclick="switchTab('answer')" id="tab-answer">è©³è§£å·</div>
            <div class="tab" onclick="switchTab('chat')" id="tab-chat">è¨è«–å€</div>
        </div>

        <div class="content-area" id="unit-content">
            <div id="panel-question" style="height: 100%; display: flex; flex-direction: column;">
                <div id="dl-question" class="download-bar" onclick="openPdf(currentUnitData?.questionPdf)">ğŸ“¥ ä¸‹è¼‰/åˆ—å°é¡Œç›®å·</div>
                <div id="viewer-question" style="flex: 1;"></div>
            </div>

            <div id="panel-answer" style="height: 100%; display: none; flex-direction: column;">
                <div id="dl-answer" class="download-bar answer" onclick="openPdf(currentUnitData?.answerPdf)">ğŸ“¥ ä¸‹è¼‰/åˆ—å°è©³è§£å·</div>
                <div id="viewer-answer" style="flex: 1;"></div>
            </div>

            <div id="panel-chat" style="display: none; height: 100%;">
                <div class="chat-container" id="chat-list">
                    <div style="text-align: center; color: #999; margin-top: 20px;">è¼‰å…¥ç•™è¨€ä¸­...</div>
                </div>

                <div class="bottom-action-area">
                    
                    <div id="chat-input-area" class="input-row" style="display: none;">
                        <input type="text" id="comment-input" class="chat-input" placeholder="è¼¸å…¥å•é¡Œ..." onkeypress="handleEnter(event)">
                        <button class="send-btn" onclick="sendComment()">é€å‡º</button>
                    </div>

                    <div id="chat-auth-ui" class="auth-row">
                        <div class="auth-title">è«‹ç™»å…¥ä»¥åƒèˆ‡è¨è«– (æ–°åŒå­¸è«‹æŒ‰è¨»å†Š)</div>
                        <div class="auth-inputs">
                            <input type="email" id="chat-email" placeholder="Email">
                            <input type="password" id="chat-pwd" placeholder="å¯†ç¢¼ (6ä½ä»¥ä¸Š)">
                        </div>
                        <div class="auth-btns">
                            <button class="btn-login" onclick="loginFromChat()">ç™»å…¥</button>
                            <button class="btn-register" onclick="registerFromChat()">è¨»å†Š</button>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <div id="notification-modal" class="modal-overlay" onclick="if(event.target === this) closeNotifications()">
        <div class="modal-content">
            <div class="modal-header">
                <h3 style="margin:0;">ğŸ”” é€šçŸ¥ä¸­å¿ƒ</h3>
                <button class="close-btn" onclick="closeNotifications()">Ã—</button>
            </div>
            <div class="modal-body" id="notif-list">
                <p style="text-align: center; color: #999;">è¼‰å…¥ä¸­...</p>
            </div>
            <button class="btn" style="background: #eee; color: #666; margin-top:15px;" onclick="closeNotifications()">é—œé–‰ä¸¦æ¸…é™¤ç´…é»</button>
        </div>
    </div>

    <div id="settings-modal" class="modal-overlay" onclick="if(event.target === this) this.style.display='none'">
        <div class="modal-content" style="text-align: center;">
            <h2 id="settings-title">å¸³è™Ÿè¨­å®š</h2>
            <p id="settings-user-info"></p>
            <button class="btn btn-red" onclick="logout()">ç™»å‡º</button>
            <button class="btn" style="background: #ccc; color: #333;" onclick="document.getElementById('settings-modal').style.display='none'">å–æ¶ˆ</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, query, orderBy, limit, onSnapshot, getDocs, getDoc, doc, where, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // â–¼â–¼â–¼ è«‹å¡«å…¥ä½ çš„ Firebase Config â–¼â–¼â–¼
        const firebaseConfig = {
  apiKey: "AIzaSyA4rX2ZjJqto9Eyv4G_xdlAdYAH3uJCMBo",
  authDomain: "reviewtest-f016d.firebaseapp.com",
  projectId: "reviewtest-f016d",
  storageBucket: "reviewtest-f016d.firebasestorage.app",
  messagingSenderId: "170552561842",
  appId: "1:170552561842:web:a204553261698d7311b9ab",
  measurementId: "G-RQ20L5H9S4"
};
        // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const ADMIN_EMAIL = "ulysses950710@gmail.com";

        window.currentUser = null;
        window.currentUnitData = null;
        window.currentUnitId = null;
        let unsubscribeChat = null;

        // --- 1. èº«ä»½é©—è­‰ç›£è½ (æ§åˆ¶èŠå¤©å®¤åº•éƒ¨ UI) ---
        onAuthStateChanged(auth, (user) => {
            window.currentUser = user;
            
            // æ›´æ–°èŠå¤©å®¤åº•éƒ¨ä»‹é¢
            const inputArea = document.getElementById('chat-input-area');
            const authUI = document.getElementById('chat-auth-ui');
            
            if (user) {
                // å·²ç™»å…¥
                inputArea.style.display = 'flex';
                authUI.style.display = 'none';
                
                // æ›´æ–°è¨­å®šè¦–çª—è³‡è¨Š
                document.getElementById('settings-user-info').innerText = `ç›®å‰ç™»å…¥ï¼š${user.email}`;
                
                // é¦–é æ­¡è¿è©
                document.getElementById('greeting-text').innerText = `å—¨! ${user.displayName || user.email.split('@')[0]} åŒå­¸`;

                // è€å¸«ä»‹é¢
                if (user.email === ADMIN_EMAIL) {
                    document.getElementById('teacher-section').style.display = 'block';
                    fetchUnitsForAdmin();
                } else {
                    document.getElementById('teacher-section').style.display = 'none';
                }
            } else {
                // æœªç™»å…¥
                inputArea.style.display = 'none';
                authUI.style.display = 'flex'; // é¡¯ç¤ºå…§åµŒç™»å…¥æ¡†
                document.getElementById('greeting-text').innerText = "å—¨! åŒå­¸ é¸æ“‡ç§‘ç›®ä¾†ç·´ç¿’å§";
            }
            
            listenNotifications();
        });

        // èŠå¤©å®¤å…§çš„ç™»å…¥
        window.loginFromChat = async () => {
            const email = document.getElementById('chat-email').value;
            const pwd = document.getElementById('chat-pwd').value;
            if(!email || !pwd) return alert("è«‹è¼¸å…¥ Email å’Œå¯†ç¢¼");
            try { 
                await signInWithEmailAndPassword(auth, email, pwd); 
                // ç™»å…¥æˆåŠŸå¾Œ onAuthStateChanged æœƒè‡ªå‹•åˆ‡æ› UI
            } catch(e) { alert("ç™»å…¥å¤±æ•—: " + e.message); }
        };

        // èŠå¤©å®¤å…§çš„è¨»å†Š (æ–°å¢åŠŸèƒ½)
        window.registerFromChat = async () => {
            const email = document.getElementById('chat-email').value;
            const pwd = document.getElementById('chat-pwd').value;
            if(!email || !pwd) return alert("è«‹è¼¸å…¥ Email å’Œå¯†ç¢¼");
            try {
                await createUserWithEmailAndPassword(auth, email, pwd);
                alert("è¨»å†ŠæˆåŠŸï¼");
            } catch(e) { alert("è¨»å†Šå¤±æ•—: " + e.message); }
        };

        window.logout = async () => { 
            await signOut(auth); 
            document.getElementById('settings-modal').style.display='none'; 
        };

        window.openSettings = () => {
            if(!window.currentUser) {
                alert("è«‹ç›´æ¥åœ¨å–®å…ƒè¨è«–å€ä¸‹æ–¹ç™»å…¥å³å¯");
                // ç‚ºäº†æ–¹ä¾¿ï¼Œå¦‚æœæ²’ç™»å…¥é»äººé ­ï¼Œå¯ä»¥ç›´æ¥å°å‘æŸå€‹å–®å…ƒæˆ–æç¤º
            } else {
                document.getElementById('settings-modal').style.display = 'flex';
            }
        };

        // --- 2. é€šçŸ¥ä¸­å¿ƒé‚è¼¯ (æ–°åŠŸèƒ½) ---
        window.openNotifications = async () => {
            document.getElementById('notification-modal').style.display = 'flex';
            const listEl = document.getElementById('notif-list');
            listEl.innerHTML = '<p style="text-align: center; color: #999;">è¼‰å…¥ä¸­...</p>';

            try {
                // æ’ˆå–æœ€è¿‘ 20 ç­†é€šçŸ¥
                const q = query(collection(db, 'notifications'), orderBy('createdAt', 'desc'), limit(20));
                const snap = await getDocs(q);
                
                if(snap.empty) {
                    listEl.innerHTML = '<p style="text-align: center; margin-top: 20px;">ç›®å‰æ²’æœ‰æ–°é€šçŸ¥</p>';
                    return;
                }

                let html = '';
                const lastRead = parseInt(localStorage.getItem('lastReadTime') || '0');

                snap.forEach(doc => {
                    const data = doc.data();
                    // æ¿¾æ‰è‡ªå·±ç™¼çš„
                    if(window.currentUser && data.senderEmail === window.currentUser.email) return;

                    const isNew = (data.createdAt?.toMillis() || 0) > lastRead;
                    const date = data.createdAt ? new Date(data.createdAt.toMillis()).toLocaleString() : '';
                    
                    // é»æ“Šé€šçŸ¥è·³è½‰é‚è¼¯
                    const onClickAttr = `onclick="handleNotificationClick('${data.unitId}', '${data.targetTab}')"`;

                    html += `
                        <div class="notif-item" ${onClickAttr}>
                            <div class="notif-title">
                                ${isNew ? '<span class="new-badge"></span>' : ''}
                                ${data.title}
                            </div>
                            <div class="notif-body">${data.body}</div>
                            <div class="notif-time">${date}</div>
                        </div>
                    `;
                });
                listEl.innerHTML = html || '<p style="text-align: center;">æ²’æœ‰å…¶ä»–äººçš„é€šçŸ¥</p>';
            } catch(e) {
                console.error(e);
                listEl.innerHTML = 'è¼‰å…¥å¤±æ•—';
            }
        };

        window.closeNotifications = () => {
            document.getElementById('notification-modal').style.display = 'none';
            // é—œé–‰æ™‚æ‰æ¸…é™¤ç´…é» (æ›´æ–°è®€å–æ™‚é–“)
            localStorage.setItem('lastReadTime', Date.now().toString());
            document.getElementById('badge').style.display = 'none';
        };

        // é»æ“Šé€šçŸ¥å¾Œçš„è·³è½‰
        window.handleNotificationClick = (unitId, tab) => {
            closeNotifications(); // å…ˆé—œè¦–çª—
            if(unitId) {
                // å…ˆè·³è½‰åˆ°å–®å…ƒ
                goToUnit(unitId).then(() => {
                    // å†åˆ‡æ›åˆ°å°æ‡‰çš„ Tab (question/answer/chat)
                    if(tab) switchTab(tab);
                });
            }
        };

        // --- 3. è·¯ç”±èˆ‡é é¢é‚è¼¯ (ç¶­æŒä¸è®Š) ---
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            
            if(pageId === 'home-screen') {
                document.getElementById('back-btn').style.display = 'none';
                document.getElementById('settings-btn').style.display = 'flex';
                document.getElementById('header-title').innerText = 'é¦–é ';
            } else {
                document.getElementById('back-btn').style.display = 'flex';
                document.getElementById('settings-btn').style.display = 'none';
            }
        }

        window.handleBack = () => {
            if(document.getElementById('unit-screen').classList.contains('active')) {
                if(unsubscribeChat) { unsubscribeChat(); unsubscribeChat = null; }
                showPage('subject-screen');
                document.getElementById('header-title').innerText = 'å–®å…ƒåˆ—è¡¨';
            } else {
                showPage('home-screen');
            }
        };

        window.goToSubject = async (subjectId) => {
            showPage('subject-screen');
            const container = document.getElementById('unit-list-container');
            container.innerHTML = '<p style="text-align:center;">è¼‰å…¥ä¸­...</p>';
            document.getElementById('header-title').innerText = (subjectId === 'math' ? 'æ•¸å­¸' : 'ç†åŒ–') + 'å–®å…ƒåˆ—è¡¨';

            const themeColor = subjectId === 'math' ? '#4A90E2' : '#50E3C2';
            const q = query(collection(db, 'units'), where('subject', '==', subjectId), orderBy('order', 'asc'));
            
            try {
                const snap = await getDocs(q);
                if(snap.empty) { container.innerHTML = '<p style="text-align:center;">ç„¡å–®å…ƒ</p>'; return; }
                let html = '';
                snap.forEach(doc => {
                    const data = doc.data();
                    html += `
                        <div class="unit-card" onclick="goToUnit('${doc.id}')">
                            <div class="unit-icon" style="background-color: ${themeColor};">${subjectId === 'math'?'ğŸ“':'ğŸ§ª'}</div>
                            <div><h3>${data.title}</h3><p>é»æ“ŠæŸ¥çœ‹é¡Œç›®èˆ‡è©³è§£</p></div>
                        </div>`;
                });
                container.innerHTML = html;
            } catch(e) { console.error(e); container.innerHTML = 'è®€å–éŒ¯èª¤'; }
        };

        window.goToUnit = async (unitId) => {
            window.currentUnitId = unitId;
            showPage('unit-screen');
            document.getElementById('header-title').innerText = 'è¼‰å…¥ä¸­...';
            switchTab('question');

            try {
                const docSnap = await getDoc(doc(db, 'units', unitId));
                if(docSnap.exists()) {
                    window.currentUnitData = docSnap.data();
                    document.getElementById('header-title').innerText = window.currentUnitData.title;
                    renderPdfViewer('question', window.currentUnitData.questionPdf);
                    renderPdfViewer('answer', window.currentUnitData.answerPdf);
                } else { alert('æ‰¾ä¸åˆ°å–®å…ƒ'); handleBack(); }
            } catch(e) { console.error(e); alert('è®€å–å¤±æ•—'); }
            loadComments(unitId);
        };

        window.switchTab = (tabName) => {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.add('active');
            ['question', 'answer', 'chat'].forEach(t => {
                document.getElementById(`panel-${t}`).style.display = (t === tabName) ? (t === 'chat' ? 'block' : 'flex') : 'none';
            });
        };

        function renderPdfViewer(type, url) {
            const viewer = document.getElementById(`viewer-${type}`);
            const dlBtn = document.getElementById(`dl-${type}`);
            if(!url) {
                viewer.innerHTML = `<div class="center-msg">å°šæœªä¸Šå‚³æª”æ¡ˆ</div>`;
                dlBtn.style.display = 'none';
                return;
            }
            dlBtn.style.display = 'block';
            const isMobile = window.innerWidth < 768;
            if (isMobile) {
                viewer.innerHTML = `
                    <div class="center-msg">
                        <p>æ‰‹æ©Ÿç‰ˆå»ºè­°ç›´æ¥é–‹å•Ÿ PDF é–±è®€</p>
                        <button class="btn btn-blue" style="width:auto;" onclick="openPdf('${url}')">ğŸ“„ é»æ­¤é–‹å•Ÿ PDF</button>
                    </div>`;
            } else {
                viewer.innerHTML = `<iframe src="${url}" class="pdf-frame"></iframe>`;
            }
        }
        
        window.openPdf = (url) => { if(url) window.open(url, '_blank'); };

        function loadComments(unitId) {
            if(unsubscribeChat) unsubscribeChat();
            const q = query(collection(db, 'units', unitId, 'comments'), orderBy('createdAt', 'desc'));
            const listEl = document.getElementById('chat-list');
            
            unsubscribeChat = onSnapshot(q, (snap) => {
                if(snap.empty) {
                    listEl.innerHTML = '<div style="text-align:center;color:#999;margin-top:20px;">é‚„æ²’æœ‰ç•™è¨€ï¼Œä¾†æ¶é ­é¦™å§ï¼</div>';
                    return;
                }
                let html = '';
                snap.forEach(doc => {
                    const data = doc.data();
                    const name = data.userName || data.userEmail.split('@')[0];
                    html += `
                        <div class="comment-item">
                            <div class="comment-user">${name}:</div>
                            <div class="comment-text">${data.text}</div>
                        </div>`;
                });
                listEl.innerHTML = html;
            });
        }

        window.handleEnter = (e) => { if(e.key === 'Enter') sendComment(); };

        window.sendComment = async () => {
            const input = document.getElementById('comment-input');
            const text = input.value.trim();
            if(!text) return;
            // é›™é‡æª¢æŸ¥ï¼šå¦‚æœ UI é¡¯ç¤ºéŒ¯èª¤è®“æœªç™»å…¥è€…æŒ‰åˆ°æŒ‰éˆ•
            if(!window.currentUser) return alert('è«‹å…ˆç™»å…¥');

            const user = window.currentUser;
            const name = user.displayName || user.email.split('@')[0];
            
            try {
                await addDoc(collection(db, 'units', window.currentUnitId, 'comments'), {
                    text: text,
                    userEmail: user.email,
                    userName: name,
                    createdAt: serverTimestamp()
                });
                await addDoc(collection(db, 'notifications'), {
                    type: 'comment',
                    title: `ğŸ’¬ ${window.currentUnitData.title} æœ‰æ–°ç•™è¨€`,
                    body: `${name}: ${text}`,
                    unitId: window.currentUnitId,
                    targetTab: 'chat',
                    createdAt: serverTimestamp(),
                    senderEmail: user.email
                });
                input.value = '';
                document.getElementById('unit-content').scrollTop = 0;
            } catch(e) { console.error(e); alert('ç•™è¨€å¤±æ•—'); }
        };

        // --- è€å¸«èˆ‡ç´…é» ---
        async function fetchUnitsForAdmin() {
            const q = query(collection(db, 'units'), orderBy('order', 'asc'));
            const snap = await getDocs(q);
            const select = document.getElementById('admin-unit-select');
            select.innerHTML = '';
            snap.forEach(doc => {
                const opt = document.createElement('option');
                opt.value = doc.id;
                opt.text = doc.data().title;
                opt.dataset.title = doc.data().title;
                select.appendChild(opt);
            });
        }

        window.simulateTeacherUpload = async (type) => {
            const select = document.getElementById('admin-unit-select');
            const unitId = select.value;
            if(!unitId) return alert('è«‹é¸æ“‡å–®å…ƒ');
            const title = select.options[select.selectedIndex].dataset.title;
            const isQ = type === 'question';
            try {
                await addDoc(collection(db, 'notifications'), {
                    type: 'file',
                    title: isQ ? 'ğŸ“„ é¡Œç›®å·' : 'âœ… è©³è§£å·',
                    body: `å–®å…ƒã€Œ${title}ã€å·²ç¶“æ›´æ–°${isQ?'é¡Œç›®':'è©³è§£'}å›‰ï¼`,
                    unitId: unitId,
                    senderEmail: window.currentUser.email,
                    targetTab: type,
                    createdAt: serverTimestamp()
                });
                alert('å·²ç™¼é€é€šçŸ¥ï¼');
            } catch(e) { alert(e.message); }
        };

        function listenNotifications() {
            const lastRead = parseInt(localStorage.getItem('lastReadTime') || '0');
            const q = query(collection(db, 'notifications'), orderBy('createdAt', 'desc'), limit(50));
            onSnapshot(q, (snap) => {
                const count = snap.docs.filter(doc => {
                    const d = doc.data();
                    const isNew = (d.createdAt?.toMillis() || 0) > lastRead;
                    const notMe = window.currentUser ? d.senderEmail !== window.currentUser.email : true;
                    return isNew && notMe;
                }).length;
                const badge = document.getElementById('badge');
                if(count > 0) { badge.style.display = 'flex'; badge.innerText = count>9?'9+':count; }
                else badge.style.display = 'none';
            });
        }
    </script>
</body>
</html>